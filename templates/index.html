<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Agente de Banca Ismart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    #chatbox {
      height: 400px; overflow-y: auto;
      background: white; padding: 15px;
      border-radius: 8px; border: 1px solid #ddd;
      margin-bottom: 1rem;
    }
    .msg-user { text-align: right; color: #0d6efd; margin: 5px 0; }
    .msg-banca { text-align: left; color: #198754; margin: 5px 0; }
    .logo { max-height: 50px; margin-bottom: 1rem; }
  </style>
</head>
<body class="container py-4">
  <div class="text-center">
    <img src="https://www.ismart.org.br/wp-content/uploads/2022/03/ISMART_logo.svg" class="logo" alt="Ismart Logo">
    <h2>ðŸŽ“ Simulador de Banca Ismart</h2>
  </div>

  <div id="chatbox"></div>

  <form id="chat-form" class="d-flex mb-2">
    <input type="text" name="message" id="message" class="form-control me-2" placeholder="Digite sua fala...">
    <button type="submit" class="btn btn-primary">Enviar</button>
  </form>

  <button id="micBtn" class="btn btn-outline-secondary mb-3">ðŸŽ¤ Falar</button>
  <audio id="audioPlayer" controls class="w-100 mt-2"></audio>

  <script>
    const form = document.getElementById("chat-form");
    const chatbox = document.getElementById("chatbox");
    const micBtn = document.getElementById("micBtn");
    const audioPlayer = document.getElementById("audioPlayer");

    form.onsubmit = async (e) => {
      e.preventDefault();
      const input = document.getElementById("message");
      const userMsg = input.value;
      if (!userMsg) return;

      chatbox.innerHTML += `<div class="msg-user"><b>VocÃª:</b> ${userMsg}</div>`;
      input.value = "";

      const formData = new FormData();
      formData.append("message", userMsg);

      const response = await fetch("/chat", { method: "POST", body: formData });
      const reply = await response.text();

      chatbox.innerHTML += `<div class="msg-banca"><b>Banca:</b> ${reply}</div>`;
      chatbox.scrollTop = chatbox.scrollHeight;

      // Tocar Ã¡udio da banca
      const ttsResp = await fetch("/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: reply })
      });
      const ttsData = await ttsResp.json();
      audioPlayer.src = ttsData.audio + "?t=" + Date.now(); // evitar cache
      audioPlayer.play();
    };

    micBtn.onclick = async () => {
      // Captura de Ã¡udio do usuÃ¡rio
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      let chunks = [];

      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/wav" });
        const formData = new FormData();
        formData.append("audio", blob, "input.wav");

        const sttResp = await fetch("/stt", { method: "POST", body: formData });
        const sttData = await sttResp.json();
        document.getElementById("message").value = sttData.text;
      };

      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 4000); // grava 4s
    };
  </script>
</body>
</html>
